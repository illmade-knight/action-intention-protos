const fs = require('fs');
const path = require('path');

const tsGenDir = path.join(__dirname, '..', 'gen', 'ts');
const tsRealDir = path.join(__dirname, '..', 'real', 'ts'); // NEW: Source for idiomatic TS files
const indexPath = path.join(tsGenDir, 'index.ts');

console.log('Creating TypeScript barrel file (index.ts)...');

/**
 * Recursively finds all files in a directory that match the pattern '_pb.ts'.
 * @param {string} dir The directory to search.
 * @returns {string[]} An array of file paths relative to the starting directory.
 */
function findProtoFiles(dir) {
    let results = [];
    const list = fs.readdirSync(dir);
    list.forEach(file => {
        const filePath = path.join(dir, file);
        const stat = fs.statSync(filePath);
        if (stat && stat.isDirectory()) {
            // Recurse into a subdirectory
            results = results.concat(findProtoFiles(filePath));
        } else if (file.endsWith('_pb.ts')) {
            // Found a match
            results.push(filePath);
        }
    });
    return results;
}

function findTsFiles(dir) {
    let results = [];
    if (!fs.existsSync(dir)) {
        return results;
    }
    const list = fs.readdirSync(dir);
    list.forEach(file => {
        const filePath = path.join(dir, file);
        const stat = fs.statSync(filePath);
        if (stat && stat.isDirectory()) {
            // Recurse into a subdirectory
            results = results.concat(findTsFiles(filePath));
        } else if (file.endsWith('.ts')) {
            // Found a TypeScript file
            results.push(filePath);
        }
    });
    return results;
}

try {
    var protoFiles = []
    if (!fs.existsSync(tsGenDir)) {
        console.warn(`Warning: TypeScript generation directory not found at ${tsGenDir}. Skipping index creation.`);

    } else {
        protoFiles = findProtoFiles(tsGenDir);
    }

    var realFiles = []
    if (!fs.existsSync(tsRealDir)) {
        console.warn(`Warning: TypeScript real directory not found at ${tsGenDir}. Skipping index creation.`);
    } else
        realFiles = findTsFiles(tsRealDir);

    // Step 3: Combine both lists of files.
    const allFiles = [...protoFiles, ...realFiles];

    if (allFiles.length === 0) {
        console.log('No files found to export. Index file will be empty.');
        fs.writeFileSync(indexPath, '// No models to export\n');
        process.exit(0);
    }

    // Create export statements with relative paths from the index file's location.
    // The .js extension is required for modern ESM compatibility.
    const exports = allFiles.map(filePath => {
        const relativePath = path.relative(tsGenDir, filePath);
        // Use forward slashes for cross-platform compatibility in import paths
        const modulePath = relativePath.replace(/\\/g, '/').replace('.ts', '.js');
        return `export * from './${modulePath}';`;
    });

    const content = `// This file is auto-generated by the create-ts-index.js script. Do not edit.\n\n` +
        exports.join('\n') + '\n';

    fs.writeFileSync(indexPath, content);
    console.log(`Successfully created index.ts with ${protoFiles.length} exports.`);

} catch (error) {
    console.error('Failed to create TypeScript index file:', error);
    process.exit(1);
}

