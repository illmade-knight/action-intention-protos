# This workflow is triggered ONLY when a new version tag (e.g., v1.0.1) is pushed.
# Its sole job is to generate and publish the Go module for that specific version.

name: Publish Go Module

on:
  push:
    tags:
      - 'v*' # Trigger on tags like v1.0.0, v1.2.3, etc.

jobs:
  publish-go:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repository at the specific tag
        uses: actions/checkout@v4
        with:
          path: main

      - name: Checkout Go module repository
        uses: actions/checkout@v4
        with:
          repository: illmade-knight/go-action-intention-protos
          path: go-protos
          token: ${{ secrets.GH_PAT }}

      - name: Setup Buf, Go, and Node.js
        uses: bufbuild/buf-setup-action@v1
      - uses: actions/setup-go@v4
        with: { go-version: '1.21' }
      - uses: actions/setup-node@v4
        with: { node-version: '18' }

      - name: Install dependencies and plugins
        working-directory: ./main
        run: |
          npm install
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest

      - name: Generate Go code
        working-directory: ./main
        run: buf generate --output ../go-protos

      - name: Initialize and Tidy Go Module
        working-directory: ./go-protos
        run: |
          go mod init github.com/illmade-knight/go-action-intention-protos
          go mod edit -go=1.21
          go mod tidy

      - name: Commit and push Go module
        working-directory: ./go-protos
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "chore(release): update generated Go modules for ${{ github.ref_name }}" || exit 0
          git push

